---
title: 分布式架构
date: "2019-12-22T22:40:32.169Z"
path: "/distributed-architecture"
tags:
    - middleware
---

## 2PC (two phase commit, 二阶段提交)
绝大部分关系型数据库采用二阶段提交协议来完成分布式事务处理.
阶段一: 提交事务请求
阶段二: 执行事务提交
1. 假如协调者从所有参与者得到的反馈都是yes响应, 那么**执行事务提交**
2. 假如任何一个参与者向协调者反馈了no响应, 或者等待超时之后, 协调者就会**中断事务**

优点: 原理简单, 实现方便
缺点:
* 同步阻塞: 各个参与者在等待其他参与这的过程中, 无法进行其他任何操作
* 单点问题: 协调者一旦出现问题, 则二阶段提交无法运转
* 数据不一致: 阶段二中, 执行事务提交的时候, 若只有部分参与者收到了commit请求(3PC试图解决), 则整个分布式系统会有数据不一致
* 过于保守: 没有容错机制, 任何一个参与者失败则导致整个事务的失败

## 3PC (three phase commit, 三阶段提交)
阶段一: canCommit, 协调者事务询问, 参与者反馈相应
阶段二: preCommit, 协调者根据阶段一中是否所有参与者都反馈了yes, 执行事务预提交或中断事务
阶段三: doCommit, 执行提交, 参与者正式执行事务提交操作, 发送ack消息, 此时若有任何参与者反馈了no响应,
      则协调者会发送中断请求, 参与者执行回滚

* 注意, 一旦进入阶段三, 无论是协调者出现故障, 还是网络出现分区, 参与者没有收到doCommit和中断请求,
  参与者都会在等待超时之后, 继续进行**事务提交**

优点: 降低了参与者的阻塞范围, 并且能在单点故障后继续达成一致
缺点: 部分参与者preCommit后出现网络分区, 则会出现数据不一致

## Q & A

* 分布式集群下如何做到唯一序列号
* 设计一个秒杀系统，30分钟没付款就自动关闭交易
* 如何使用redis和zookeeper实现分布式锁
* redlock，算法实现，争议点
* 分布式事务的原理，优缺点，如何使用分布式事务，2pc 3pc 的区别
* 一致性hash
* 设计建立和保持100w的长连接
* 解释什么是MESI协议(缓存一致性)
* paxos算法， 什么是zab协议
* 实现分布式环境下的countDownLatch

* 限流策略，令牌桶和漏斗算法的使用场景
* 分布式服务调用方，不依赖服务提供方的话，怎么处理服务方挂掉后，大量无效资源请求
  的浪费，如果只是服务提供方吞吐不高的时候该怎么做，如果服务挂了，那么一会重启，该怎
  么做到最小的资源浪费，流量半开的实现机制是什么